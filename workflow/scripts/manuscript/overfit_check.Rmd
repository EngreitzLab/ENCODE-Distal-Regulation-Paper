---
title: "Check for ENCODE-rE2G overfitting"
author: "Andreas R. Gschwind"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setupDocument, include=FALSE}
# save.image("overfit_check.rda")
# stop()

# set output html chunk options
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)

# set random seed
set.seed(snakemake@params$seed)
```

## Goal
Compare performance of ENCODE-rE2G and ENCODE-rE2G_Extended models using
leave-one-chromosome-out cross-validation (LOCOV) or no cross-validation on K562 training data to
check if models used for genome-wider predictions overfit the training data.
```{r attachPackages, message=FALSE, warning=FALSE}
# attach required packages
library(tidyverse)
library(cowplot)
library(GenomicRanges)
library(ROCR)
library(caTools)

# required functions
proj_dir <- snakemake@config$proj_dir
source(file.path(proj_dir, "CRISPR_benchmarks/workflow/scripts/crisprComparisonLoadInputData.R"))
source(file.path(proj_dir, "CRISPR_benchmarks/workflow/scripts/crisprComparisonPlotFunctions.R"))
source(file.path(proj_dir, "CRISPR_benchmarks/workflow/scripts/crisprComparisonBootstrapFunctions.R"))
```

***

## Load and process input data
Load and process output from CRISPR benchmarking pipeline.
```{r loadData}
# load performance summary
perf <- fread(snakemake@input$perf)

# load merged data for the combined CRISPR dataset
merged <- fread(snakemake@input$merged)

# load pred_config file
pred_config <- importPredConfig(snakemake@input$pred_config, expr = TRUE)

# process merged data for benchmarking analyses, including filtering for ValidConnection == TRUE
merged <- processMergedData(merged, pred_config = pred_config,
                            filter_valid_connections = TRUE,
                            include_missing_predictions = TRUE)

# get colors of all predictors
pred_colors <- deframe(select(pred_config, pred_name_long, color))
```

***

# Precision-Revcall Curve
Plot PRC for cross-validated vs. non-cross-validated ENCODE-rE2G models.
```{r, fig.height=4, fig.width=7.5}
# compute precision-recall table
pr <- calcPRCurves(merged, pred_config = pred_config, pos_col = "Regulated")

# calculate number and percentage of experimental true positives in the CRISPR dataset
n_pos <- calcNPos(merged, pos_col = "Regulated")
pct_pos <- calcPctPos(merged, pos_col = "Regulated")

# title for plot
prc_title <- "Precision-Recall Curves"

# make precision-recall curve plot
plot_prc <- makePRCurvePlot(pr, n_pos = n_pos, pct_pos = pct_pos, plot_name = prc_title,
                       pred_config = pred_config, min_sensitivity = 0.7, line_width = 0.8,
                       point_size = 3, text_size = 15, colors = pred_colors,
                       plot_thresholds = FALSE) +
  geom_vline(xintercept = 0.7, linetype = "dashed", color = "black")
  
plot_prc
```

***

## AUPRC
Compare AUPRC between cross-validated and non-cross-validated ENCODE-rE2G models.
```{r, fig.height=4, fig.width=4}
# get ENCODE-rE2G performance only
e2g_perf <- filter(perf, pred_uid != "baseline.distToTSS")

# get AUPRC for distance to TSS baseline predictor
auprc_dist_to_tss <- perf %>% 
  filter(pred_uid == "baseline.distToTSS") %>% 
  pull(AUPRC)

# plot AUPRC
plot_auprc <- ggplot(e2g_perf, aes(y = pred_name_long, x = AUPRC, fill = pred_name_long)) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(xmin = AUPRC_lowerCi, xmax = AUPRC_upperCi), color = "black", width = 0.2) +
  geom_vline(xintercept = auprc_dist_to_tss, linetype = "dashed") +
  scale_fill_manual(values = pred_colors) +
  theme_classic() +
  theme(legend.position = "none", axis.title.y = element_blank())
```

```{r}
# convert merged data to bootstrapping format
merged_bs <- convertMergedForBootstrap(merged, pred_config = pred_config)

# compute all pairwise delta bootstraps
pw_delta_auprc <- bootstrapDeltaPerformance(merged_bs, metric = "auprc", R = 1000, conf = 0.95,
                                            ci_type = "perc", ncpus = 4)
```

***

## Make figure
Arrange plots into one figure.
```{r, fig.height=3.5, fig.width=11}
plot_grid(
  plot_auprc, 
  plot_prc,
  rel_widths = c(0.6, 1))
```

